#!/bin/bash

# Update Homebrew, and upgrade Homebrew packages and Mac App Store apps

set -euo pipefail

box_out() {
  local s="$1"

  # The length of the string plus padding
  local len=$((${#s} + 2))

  # Create the top, middle, and bottom parts of the box using heavy lines.
  local top="┏$(printf '━%.0s' $(seq 1 $len))┓"
  local middle="┃ $s ┃"
  local bottom="┗$(printf '━%.0s' $(seq 1 $len))┛"

  # Print the box to the screen.
  echo "$top"
  echo "$middle"
  echo "$bottom"
}

box_out "Update Homebrew"
brew update
echo "DONE"
echo

box_out "Upgrade installed formulae"
brew upgrade
echo "DONE"
echo

box_out "Cleanup old versions"
brew cleanup
echo "DONE"
echo

box_out "Upgrade Mac App Store apps"
mas list | while IFS= read -r line; do
  app_id=$(echo "$line" | awk '{print $1}')

  # Extract the part after the ID and then clean up spaces
  # This pattern matches the App ID and then captures everything until the last opening parenthesis
  app_name=$(echo "$line" | sed -E 's/^[0-9]+[[:space:]]*(.*)[[:space:]]+\([0-9]+\.[0-9.]+\)$/\1/' | sed 's/^[[:space:]]*//;s/[[:space:]]*$//')

  if [[ -n "$app_id" ]]; then
    echo -n "Attempting to upgrade '$app_name' (ID: $app_id)..."
    mas upgrade --verbose "$app_id"
  fi
  echo "OK"
done
echo "DONE"
echo

echo
echo "ALL UPGRADES COMPLETED"
