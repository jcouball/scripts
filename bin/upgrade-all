#!/bin/bash

# Update Homebrew, and upgrade Homebrew packages and Mac App Store apps

set -euo pipefail

box_out() {
  local s="$1"

  # The length of the string plus padding
  local len=$((${#s} + 2))

  # Create the top, middle, and bottom parts of the box using heavy lines.
  local top="┏$(printf '━%.0s' $(seq 1 $len))┓"
  local middle="┃ $s ┃"
  local bottom="┗$(printf '━%.0s' $(seq 1 $len))┛"

  # Print the box to the screen.
  echo "$top"
  echo "$middle"
  echo "$bottom"
}

box_out "Update Homebrew"
brew update
echo "DONE"
echo

box_out "Upgrade installed formulae"
brew upgrade
echo "DONE"
echo

box_out "Cleanup old versions"
brew cleanup
echo "DONE"
echo

box_out "Upgrade Mac App Store apps"
mas list | while IFS= read -r line; do
  app_id=$(echo "$line" | awk '{print $1}')
  app_name=$(echo "$line" | cut -d' ' -f2-)

  if [[ -n "$app_id" ]]; then
    echo -n "Attempting to upgrade '$app_name' (ID: $app_id)..."
    mas upgrade --verbose "$app_id"
    echo "DONE"
  fi
done
echo "DONE"
echo

echo
echo "ALL UPGRADES COMPLETED"
